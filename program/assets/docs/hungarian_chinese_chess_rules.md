# 匈汉象棋规则设计文档

## 1. 概述

匈汉象棋是一种在13×13棋盘上进行的中国象棋变体。它保留了传统中国象棋的核心元素，同时加入了新的棋子和创新规则，增加了游戏的策略性和复杂性。

## 2. 棋盘和初始布局

### 2.1 棋盘
- 棋盘为13×13格
- 保留九宫的概念，红方九宫位于第9-11行，第5-7列；黑方九宫位于第1-3行，第5-7列
- 河界大致位于第6-7行之间

### 2.2 棋子颜色
- 红方（先手）：漢、俥、傌、相、仕、炮、兵、尉、射、檑、甲、刺、楯、巡
- 黑方（后手）：汗、車、馬、象、士、砲、卒、衛、䠶、礌、胄、伺、碷、廵

### 2.3 初始棋子摆放
#### 黑方布局（上方）
- **第0行**：黑方䠶(0,0)、黑方碷(0,1)、黑方車(0,2)、黑方伺(0,3)、黑方礌(0,4)、黑方碷(0,5)、黑方衛(0,6)、黑方碷(0,7)、黑方礌(0,8)、黑方伺(0,9)、黑方車(0,10)、黑方碷(0,11)、黑方䠶(0,12)
- **第1行**：黑方馬(1,3)、黑方象(1,4)、黑方士(1,5)、黑方汗(1,6)、黑方士(1,7)、黑方象(1,8)、黑方馬(1,9)
- **第3行**：黑方砲(3,1)、黑方砲(3,11)
- **第4行**：黑方卒(4,0)、黑方卒(4,2)、黑方卒(4,4)、黑方卒(4,6)、黑方卒(4,8)、黑方卒(4,10)、黑方卒(4,12)
- **第5行**：黑方廵(5,0)、黑方廵(5,12)

#### 红方布局（下方）
- **第7行**：红方廵(7,0)、红方廵(7,12)
- **第8行**：红方兵(8,0)、红方兵(8,2)、红方兵(8,4)、红方兵(8,6)、红方兵(8,8)、红方兵(8,10)、红方兵(8,12)
- **第9行**：红方炮(9,1)、红方炮(9,11)
- **第11行**：红方俥(11,2)、红方傌(11,3)、红方相(11,4)、红方仕(11,5)、红方漢(11,6)、红方仕(11,7)、红方相(11,8)、红方傌(11,9)、红方俥(11,10)
- **第12行**：红方楯(12,1)、红方射(12,0)、红方甲(12,2)、红方甲(12,10)、红方刺(12,3)、红方刺(12,9)、红方尉(12,6)、红方檑(12,4)、红方檑(12,8)、红方射(12,12)、红方楯(12,11)

## 3. 基本棋子规则

### 3.1 将/帅 (漢/汗)
- 名称：红方为"漢"，黑方为"汗"
- 移动规则：
  - 可在九宫内自由移动
  - 可以出九宫（根据设置决定）
  - 出九宫后可能失去斜走能力（根据设置决定）
  - 保持基本的直走、横走能力
- 特殊胜利条件：将帅进入对方九宫即获胜
- 将帅对脸规则：当双方将帅直接相对且中间无子时，此移动被禁止
- 九宫范围：红方九宫在第9-11行，第5-7列；黑方九宫在第1-3行，第5-7列

### 3.2 車/俥 (车)
- 移动规则：横、竖方向不限格数移动
- 吃子规则：与移动规则相同
- 路径检查：移动路径上不能有其他棋子阻挡
- 移动路径检查：如果[from_row == to_row]（横向移动），检查[min(from_col, to_col)+1]到[max(from_col, to_col)]之间的列是否有棋子；如果[from_col == to_col]（纵向移动），检查[min(from_row, to_row)+1]到[max(from_row, to_row)]之间的行是否有棋子

### 3.3 馬/傌 (马)
- 移动规则：日字跳法，不能蹩马腿
- 吃子规则：与移动规则相同
- 标准日字移动：((row_diff == 2 and col_diff == 1) or (row_diff == 1 and col_diff == 2))
- 特殊规则：可根据设置允许马直走三格
- 蹩马腿检查：如果[row_diff == 2]，检查[from_row + (1 if to_row > from_row else -1), from_col]位置；如果[col_diff == 2]，检查[from_row, from_col + (1 if to_col > from_col else -1)]位置

### 3.4 相/象 (相)
- 移动规则：田字跳法，不能塞象眼
- 可以过河（根据设置决定）
- 特殊能力：在敌方区域时，获得横竖隔一格吃子的能力
- 田字移动：[abs(to_row - from_row) == 2 and abs(to_col - from_col) == 2]
- 塞象眼检查：[center_row = (from_row + to_row) // 2, center_col = (from_col + to_col) // 2]
- 敌方区域特殊能力：当相在敌方区域时，可以横竖方向隔一格移动（必须检查中间位置是否有棋子阻挡）

### 3.5 士/仕 (士)
- 移动规则：九宫内斜走
- 可以出九宫（根据设置决定）
- 出九宫后可能获得直走能力（根据设置决定）
- 九宫内规则：斜走一格，[abs(row_diff) == 1 and abs(col_diff) == 1]
- 出九宫规则：可直走或斜走一格（如果设置允许）

### 3.6 炮/砲 (炮)
- 移动规则：横、竖方向不限格数移动
- 吃子规则：需要炮架，隔一个棋子吃子
- 移动路径检查：移动时路径上不能有任何棋子
- 吃子路径检查：吃子时路径上必须且仅有一个棋子作为炮架
- 炮架计数：[pieces_in_path]变量统计路径上的棋子数量，移动时[pieces_in_path == 0]，吃子时[pieces_in_path == 1]

### 3.7 兵/卒 (兵)
- 移动规则：
  - **未过河阶段**（黑方：第0-5行，红方：第7-12行）：
    - 只能向前移动一格（黑方向下，红方向上）
    - 不能横向移动
  - **过河后阶段**（黑方：第6-11行，红方：第1-6行）：
    - 可向前、左、右移动一格
    - 不能后退
  - **底线阶段**（黑方：第12行，红方：第0行）：
    - 根据设置可能具备完整移动能力（前、后、左、右）
- 吃子规则：移动方向上的敌方棋子
- 特殊规则：到达对方底线时可升变为阵亡的己方棋子

## 4. 新增特色棋子规则

### 4.1 尉/衛 (尉)
- 移动规则：直线跨越移动，越过第一个遇到的棋子后，可在碰撞前的区间内移动
- 吃子规则：与移动规则相同（根据实现可能有限制）
- 跨越规则：必须先跨越至少一个棋子，然后移动到跨越点之后的空位置
- 直线移动：可横向、纵向、斜线方向移动
- 跨越检测：寻找第一个被跨越的棋子[crossed_piece_pos]，然后检查从[crossed_piece_pos + step]到目标位置之间是否有阻挡

### 4.2 射/䠶 (射)
- 移动规则：斜向移动至无碰撞点位
- 吃子规则：与移动规则相同
- 移动限制：最多斜向移动3格，[abs(row_diff) <= 3]
- 路径检查：斜向移动路径上不能有棋子阻挡
- 夹逼规则：如果移动路径上某点的相邻方向有两个棋子形成夹逼，则路径被阻挡

### 4.3 檑/礌 (檑)
- 移动规则：可沿直线或斜线无限移动，不能越过其他棋子
- 攻击规则：只能攻击"落单"的敌方棋子（周围上下左右没有同色棋子）
- 攻击范围：必须在相邻8格内
- 孤立检测：[is_isolated()]函数检查目标棋子周围四个方向是否有同色棋子
- 夹逼规则：斜向移动时如果存在与当前移动斜线交叉的两相邻棋子形成的夹逼，则路径被阻挡

### 4.4 甲/胄 (甲)
- 移动规则：使用炮的移动方式，但仅用于移动，不能直接吃子
- 攻击规则：通过三子相连（两个己方棋子和一个敌方棋子）的方式吃子
- 移动路径：横向或纵向，移动时路径上不能有阻挡
- 三子连吃：需要两个己方棋子和一个敌方棋子呈线性连接

### 4.5 刺/伺 (刺)
- 移动规则：可直走，移动路径上必须完全无任何棋子阻挡
- 兑子规则：移动时，若移动前起始位置的反方向一格有敌棋，则与该敌棋兑子（双方都阵亡）
- 限制：不能兑盾；若与敌方盾相邻，则不能触发兑子
- 禁止移动：如果被尉照面，则不能移动
- 直线移动：只能横向或纵向移动，路径上不能有阻挡
- 兑子检测：检查移动前起始位置的反方向一格是否有敌方棋子

### 4.6 楯/碷 (盾)
- 移动规则：同尉的直线跨越移动
- 特殊规则：不可被吃，不能吃子
- 保护能力：与己方盾相邻的棋子受到保护
- 不可被吃：任何棋子都不能吃盾
- 直线跨越移动：只能直线跨越移动，不能直接移动到有棋子的位置

### 4.7 巡/廵 (巡)
- 初始位置：分别置于河界左右两侧最边缘，即第5行和第7行的第0列和第12列
- 移动规则：仅能横向移动，不可纵向、斜向移动，也不可越子
- 移动格数：为任意偶数（2格、4格、6格等），需符合河界的限制
- 河界限制：专属活动区域，不可离开第5行和第7行
- 吃子规则：限定为自身左右紧邻的第二格，仅2个目标点（左二格、右二格）
- 吃子条件：目标格有敌方棋子，且移动路径无任何棋子阻挡
- 活动范围：只能在第5行或第7行横向移动
- 移动距离：必须是偶数格（2, 4, 6, 8, 10, 12）
- 吃子范围：只能吃左右第二格的敌方棋子

## 5. 特殊规则

### 5.1 将军与将死
- 当一方的将/帅被攻击时，称为"将军"
- 被将军方必须解除将军状态
- 若无法解除将军，则被"将死"，对方获胜
- 将军检测：检查是否有敌方棋子可以移动到将/帅的位置

### 5.2 和棋规则
- 将帅照面：两将/帅直接相对无子阻隔
- 困毙：轮到走棋的一方无任何合法走法
- 三次重复局面：同一局面出现三次
- 不可取胜局面：双方均无可能取胜的简单局势

### 5.3 升变规则
- 兵/卒到达对方底线时，可选择升变为阵亡的己方棋子（除兵/卒外）
- 升变完成后，由对方继续走棋

### 5.4 兵复活规则
- 检查复活机制是否启用
- 复活位置：己方兵/卒的初始位置
- 复活条件：该位置为空，己方在局兵/卒数量不足上限，且有阵亡的兵/卒可供复活

## 6. 特殊保护与限制规则

### 6.1 楯/碷的保护能力
- 盾不可被吃：任何棋子都无法吃掉盾
- 相邻保护：与己方盾相邻的棋子受到保护，不能被吃
- 攻击限制：与敌方盾相邻的己方棋子会丧失攻击能力

### 6.2 尉的照面限制
- 尉与其他棋子照面时，被照面的棋子会被限制移动
- 刺被尉照面时，禁止移动

### 6.3 夹逼规则
- 射和檑在斜向移动时，如果存在与移动方向交叉的两个相邻棋子形成夹逼，则移动路径被阻挡

## 7. 胜负判定

### 7.1 获胜条件
- 将死对方将/帅
- 将己方将/帅移动到对方九宫
- 对方认输

### 7.2 和棋条件
- 困毙
- 三次重复局面
- 不可取胜局面
- 双方同意和棋

## 8. 游戏流程

1. 红方先行
2. 每次只能移动一枚己方棋子
3. 检查移动合法性
4. 执行移动（包括吃子）
5. 检查将军状态
6. 检查游戏结束条件
7. 切换玩家
8. 重复2-7直到游戏结束

## 9. 可配置规则设置

### 9.1 漢/汗规则设置
- [king_can_leave_palace]: 是否可以出九宫
- [king_lose_diagonal_outside_palace]: 出九宫后是否失去斜走能力
- [king_can_diagonal_in_palace]: 在九宫内是否可以斜走

### 9.2 士/仕规则设置
- [shi_can_leave_palace]: 是否可以出九宫
- [shi_gain_straight_outside_palace]: 出九宫后是否获得直走能力

### 9.3 相/象规则设置
- [xiang_can_cross_river]: 是否可以过河
- [xiang_gain_jump_two_outside_river]: 过河后是否获得隔两格吃子能力

### 9.4 马规则设置
- [ma_can_straight_three]: 是否可以获得直走三格的能力

### 9.5 兵/卒规则设置
- [pawn_backward_at_base_enabled]: 底线后退能力
- [pawn_full_movement_at_base_enabled]: 底线完整移动能力

### 9.6 棋子登场设置
- [ju_appear], [ma_appear], [xiang_appear], [shi_appear], [king_appear], [pao_appear], [pawn_appear], [wei_appear], [she_appear], [lei_appear], [jia_appear], [ci_appear], [dun_appear], [xun_appear]: 控制各种棋子是否在游戏中出现

## 10. 经典模式

匈汉象棋提供经典模式选项，使用接近传统中国象棋的布局，仅包含基础棋子及射、檑、巡三个特色棋子。